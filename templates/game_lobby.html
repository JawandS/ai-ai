{% extends "base.html" %}

{% block title %}Public Goods Game - Lobby{% endblock %}

{% block content %}
<div class="px-4 py-6" x-data="gameLobby()">
    <!-- Header -->
    <div class="mb-8">
        <h1 class="text-3xl font-bold text-gray-900 mb-2">Public Goods Game</h1>
        <p class="text-gray-600">Join or create a game to start playing</p>
    </div>

    <!-- Game Info Card -->
    <div class="bg-white rounded-xl card-shadow p-6 mb-8">
        <h2 class="text-2xl font-semibold mb-4">Game Rules</h2>
        <div class="grid md:grid-cols-2 gap-6">
            <div>
                <h3 class="font-semibold mb-2">How to Play:</h3>
                <ul class="text-gray-600 space-y-1 text-sm">
                    <li>• Each round, you receive 5 tokens</li>
                    <li>• Choose how many to keep vs. invest</li>
                    <li>• Kept tokens earn $0.20 each</li>
                    <li>• Invested tokens earn $0.10 each</li>
                    <li>• Everyone earns $0.10 per token invested by others</li>
                </ul>
            </div>
            <div>
                <h3 class="font-semibold mb-2">Game Settings:</h3>
                <ul class="text-gray-600 space-y-1 text-sm">
                    <li>• <strong>Players:</strong> 4 total (can include AI)</li>
                    <li>• <strong>Rounds:</strong> 15</li>
                    <li>• <strong>Time:</strong> ~15 minutes</li>
                    <li>• <strong>Groups:</strong> Same players each round</li>
                </ul>
            </div>
        </div>
    </div>

    <!-- Create Game Section -->
    <div class="bg-white rounded-xl card-shadow p-6 mb-8">
        <h2 class="text-2xl font-semibold mb-4">Create New Game</h2>
        
        <form @submit.prevent="createGame()" class="space-y-4">
            <div>
                <label for="playerName" class="block text-sm font-medium text-gray-700 mb-2">Your Name</label>
                <input 
                    type="text" 
                    id="playerName" 
                    x-model="playerName"
                    class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                    placeholder="Enter your name"
                    required
                >
            </div>
            
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">AI Players</label>
                <div class="flex items-center space-x-4">
                    <span class="text-sm text-gray-600">Add AI players to fill remaining spots</span>
                    <input 
                        type="range" 
                        min="0" 
                        max="3" 
                        x-model="aiPlayers"
                        class="flex-1"
                    >
                    <span x-text="aiPlayers" class="text-sm font-medium text-gray-700 w-4"></span>
                </div>
                <p class="text-xs text-gray-500 mt-1">
                    Total players: <span x-text="1 + parseInt(aiPlayers)"></span>/4
                </p>
            </div>
            
            <button 
                type="submit" 
                :disabled="isCreating"
                class="w-full bg-blue-500 hover:bg-blue-600 disabled:bg-gray-400 text-white font-semibold py-3 px-6 rounded-lg transition duration-300"
            >
                <span x-show="!isCreating">Create Game</span>
                <span x-show="isCreating">Creating...</span>
            </button>
        </form>
    </div>

    <!-- Active Games Section -->
    <div class="bg-white rounded-xl card-shadow p-6">
        <h2 class="text-2xl font-semibold mb-4">Join Existing Game</h2>
        
        <div x-show="activeGames.length === 0" class="text-center py-8 text-gray-500">
            <svg class="w-12 h-12 mx-auto mb-4 text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"></path>
            </svg>
            <p>No active games available. Create a new game to get started!</p>
        </div>
        
        <div x-show="activeGames.length > 0" class="space-y-4">
            <template x-for="game in activeGames" :key="game.id">
                <div class="border border-gray-200 rounded-lg p-4 flex items-center justify-between">
                    <div>
                        <h3 class="font-semibold" x-text="'Game ' + game.id.substring(0, 8)"></h3>
                        <p class="text-sm text-gray-600">
                            <span x-text="game.players"></span>/4 players • 
                            Status: <span x-text="game.status"></span>
                        </p>
                    </div>
                    <button 
                        @click="joinGame(game.id)"
                        :disabled="game.players >= 4"
                        class="bg-green-500 hover:bg-green-600 disabled:bg-gray-400 text-white font-semibold py-2 px-4 rounded-lg transition duration-300"
                    >
                        <span x-show="game.players < 4">Join Game</span>
                        <span x-show="game.players >= 4">Full</span>
                    </button>
                </div>
            </template>
        </div>
    </div>
</div>

<script>
function gameLobby() {
    return {
        playerName: '',
        aiPlayers: 3,
        isCreating: false,
        activeGames: [],
        
        init() {
            this.loadActiveGames();
            // Refresh games list every 5 seconds
            setInterval(() => this.loadActiveGames(), 5000);
        },
        
        async createGame() {
            if (!this.playerName.trim()) {
                alert('Please enter your name');
                return;
            }
            
            this.isCreating = true;
            
            try {
                const response = await fetch('/api/games', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        game_type: 'public-goods',
                        ai_players: parseInt(this.aiPlayers)
                    })
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    // Join the created game
                    await this.joinGame(data.game_id);
                } else {
                    alert(data.error || 'Failed to create game');
                }
            } catch (error) {
                console.error('Error creating game:', error);
                alert('Failed to create game');
            }
            
            this.isCreating = false;
        },
        
        async joinGame(gameId) {
            if (!this.playerName.trim()) {
                alert('Please enter your name');
                return;
            }
            
            try {
                const response = await fetch(`/api/games/${gameId}/join`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        player_name: this.playerName
                    })
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    // Store player info and redirect to game
                    localStorage.setItem('playerId', data.player_id);
                    localStorage.setItem('gameId', gameId);
                    window.location.href = `/game/public-goods/play/${gameId}`;
                } else {
                    alert(data.error || 'Failed to join game');
                }
            } catch (error) {
                console.error('Error joining game:', error);
                alert('Failed to join game');
            }
        },
        
        async loadActiveGames() {
            try {
                // This would normally fetch from an API endpoint
                // For now, we'll simulate some data
                this.activeGames = [
                    // Placeholder - in real implementation, fetch from /api/games endpoint
                ];
            } catch (error) {
                console.error('Error loading games:', error);
            }
        }
    }
}
</script>
{% endblock %}